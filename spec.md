# 家計簿 Web アプリ MVP 仕様書

## 1. システム概要

### 1.1 システム名（仮称）

家計簿 Web アプリ（GitHub Pages + Google Apps Script）

### 1.2 目的

* 家族共通の家計簿データを、Googleスプレッドシートを「DB」として一元管理する。
* GitHub Pages 上でホストした Web フロントから、ブラウザだけで家計簿の閲覧・登録・更新・削除を行えるようにする。
* サーバ運用やRDBを用いず、Google Apps Script（以下 GAS）とスプレッドシートのみでバックエンドを構成する。

### 1.3 範囲（MVP）

MVP では以下の機能のみ提供する。

* 支出の登録（1件ずつ）
* 支出一覧表示（指定月の一覧）
* 月別合計・カテゴリ別合計の簡易集計表示
* 登録済み支出の編集・削除
* シンプルな「共有パスワード」による利用制限（家族以外への誤利用を多少防ぐ程度）

---

## 2. システム構成

### 2.1 全体構成

* フロントエンド

  * GitHub Pages 上でホストされる静的サイト
  * 構成: HTML / CSS / JavaScript（フレームワークは任意、MVPではプレーンJS想定）
  * 役割: 画面表示・ユーザー入力・API呼び出し

* バックエンド(API)

  * Google Apps Script（Web アプリとしてデプロイ）
  * エンドポイント: `https://script.google.com/macros/s/XXXXX/exec`
  * 役割:

    * HTTP GET / POST の受付
    * 入力パラメータの検証
    * Googleスプレッドシートとのデータ連携
    * JSON レスポンスの返却
    * スプレッドシートへの書き込み処理の排他制御

* データストア

  * Googleスプレッドシート
  * 1ファイル内に「家計簿」用シートを1つ持つ（MVPでは1シート）

### 2.2 通信・オリジン

* フロント: `https://<GitHubユーザ名>.github.io/<リポジトリ名>/`
* API(GAS): `https://script.google.com/macros/s/XXXXX/exec`
* 異なるオリジン間の通信となるため、**シンプルリクエスト前提**で設計する。

  * `Content-Type: application/x-www-form-urlencoded` を使用
  * カスタムヘッダは使用しない
    → プリフライト(OPTIONS)を発生させない構成とする。

---

## 3. 利用者・前提条件

### 3.1 利用者

* 家族メンバー（数名想定）
* 各自自分のPC / スマホのブラウザから利用

### 3.2 前提条件

* 家族メンバーは共有の「家族パスワード」を知っている。
* Googleアカウントの管理・GAS / スプレッドシート管理は、管理者（例: 世帯主）が行う。
* 通信はすべて HTTPS 経由。

---

## 4. 機能要件（MVP）

### 4.1 ログイン（簡易認証）

* 共有パスワード入力画面を設ける。
* パスワードはフロントから API に送信し、GAS 側で検証する。
* 正しいパスワードでログインに成功した場合、フロントは `sessionStorage` にフラグを保存し、ログイン状態として扱う。
* パスワードはGAS内に平文で持たず、MVPでも最低限ハッシュ（例: `Utilities.computeDigest` 等）で保持することを検討する。

※ セキュリティは「家族以外にわざわざ使われない程度」を想定した簡易なものとし、本番サービスレベルの防御は範囲外とする。

### 4.2 支出登録

* 入力項目

  * 日付（必須）
  * カテゴリ（必須）
  * 金額（必須・正の整数）
  * 支払方法（任意・文字列）
  * メモ（任意）
* 登録操作

  * 画面のフォームから入力して「登録」ボタン押下
  * フロントから GAS API に `mode=add` の POST を行う
* 正常系

  * スプレッドシートの最終行に新規行として追加される
  * レスポンスとして `{status: "ok", id: "<行ID>"}` を返却
* 異常系

  * バリデーションNGの場合、 `{status:"error", message:"..."}`
  * ネットワークエラー時はフロント側でエラーメッセージ表示

### 4.3 支出一覧表示

* 画面上部で「表示年月（例: 2025-01）」を選択可能。
* フロントは選択年月を指定して API に `mode=list&year=YYYY&month=MM` で GET を送信。
* レスポンスとして、対象年月の支出一覧をJSON形式で受信し、表形式で表示する。
* 表示項目

  * 日付
  * カテゴリ
  * 金額
  * 支払方法
  * メモ
  * 編集・削除ボタン

### 4.4 集計表示（簡易）

* 一覧取得時のレスポンスに、以下の集計情報を含める。

  * 月合計金額
  * カテゴリ別合計金額（カテゴリ名 → 合計）
* 画面上に:

  * 「今月の合計: XXXX円」
  * 簡易なカテゴリ別一覧（テーブル）を表示する。

### 4.5 支出の編集

* 一覧画面の各行に「編集」ボタンを配置。
* 押下時、その行の内容をフォームに読み込んで編集可能にする。
* 編集後、「更新」ボタンで API に `mode=update` の POST を送信。
* レスポンス `{status:"ok"}` を受信したら、一覧を再読み込みする。

### 4.6 支出の削除

* 一覧画面の各行に「削除」ボタンを配置。
* 押下時、確認ダイアログ表示後、APIに `mode=delete` の POST を送信。
* レスポンス `{status:"ok"}` を受信したら、一覧から該当行を非表示にする（または再読み込み）。

---

## 5. 画面仕様（MVP）

### 5.1 画面一覧

1. ログイン画面
2. 家計簿メイン画面

   * 入力フォーム
   * 月選択ドロップダウン
   * 集計表示
   * 一覧テーブル

### 5.2 ログイン画面

* 要素

  * パスワード入力フィールド（type="password"）
  * 「ログイン」ボタン
* 挙動

  * ログインボタン押下時、API `mode=login` に POST。
  * 成功時:

    * `sessionStorage.setItem("loggedIn", "true")`
    * メイン画面へ遷移（または同ページ内で状態切り替え）
  * 失敗時:

    * 「パスワードが違います」等のメッセージ表示

### 5.3 家計簿メイン画面

#### 5.3.1 入力フォーム

* 項目

  * 日付: `<input type="date">`
  * カテゴリ: `<select>` または `<input type="text">`
  * 金額: `<input type="number" min="0">`
  * 支払方法: `<input type="text">`
  * メモ: `<input type="text">` or `<textarea>`
* ボタン

  * 「追加」／「更新」ボタン（編集モード時にラベル切替）

#### 5.3.2 集計エリア

* テキスト表示

  * 「YYYY年MM月の合計: XXXX円」
* テーブル

  * カテゴリ / 合計金額

#### 5.3.3 一覧テーブル

* カラム

  * 日付
  * カテゴリ
  * 金額
  * 支払方法
  * メモ
  * 編集ボタン
  * 削除ボタン

---

## 6. データ仕様（スプレッドシート）

### 6.1 シート構成

* スプレッドシート名: `家計簿`（任意）
* シート名: `kakeibo`（固定で扱う）

### 6.2 カラム定義（1行目ヘッダ）

| 列 | カラム名           | 型     | 説明             |
| - | -------------- | ----- | -------------- |
| A | id             | 文字列   | 行ID（内部管理用一意キー） |
| B | date           | 日付    | 支出日            |
| C | category       | 文字列   | カテゴリ           |
| D | amount         | 数値    | 金額             |
| E | payment_method | 文字列   | 支払方法           |
| F | note           | 文字列   | メモ             |
| G | created_at     | 日時文字列 | 登録日時           |
| H | updated_at     | 日時文字列 | 更新日時           |

* `id` は GAS 側で `Utilities.getUuid()` 等を使い生成。
* 日付はシート上では日付型で保持し、GASからは `YYYY-MM-DD` 形式の文字列で扱う想定。

---

## 7. API仕様（GAS Webアプリ）

### 7.1 共通

* ベースURL: `https://script.google.com/macros/s/XXXXX/exec`
* リクエスト形式:

  * GET: クエリパラメータ
  * POST: `Content-Type: application/x-www-form-urlencoded`
* 全レスポンス: `Content-Type: application/json`

#### 7.1.1 共通パラメータ

* `mode` : 処理種別

  * `login` / `add` / `list` / `update` / `delete`
* `token` : 簡易認証用トークン（共有パスワード）

  * `mode=login` ではパスワードそのものを検証
  * それ以外のmodeでは、同一の値を要求するか、省略可能とするかは運用方針に応じて決定

#### 7.1.2 共通レスポンス形式

```json
// 正常系
{
  "status": "ok",
  "data": ... // modeによって異なる
}

// 異常系
{
  "status": "error",
  "message": "エラーメッセージ"
}
```

---

### 7.2 排他制御（LockService）

* スプレッドシートに対する書き込み処理（支出登録・更新・削除）は、`LockService.getScriptLock()` による排他制御を行う。
* 各リクエスト処理開始時にロックを取得し、処理完了後に解放することで、同時実行による行番号の不整合・データ競合を防止する。
* ロック取得には `tryLock(timeoutMillis)` を使用し、取得できない場合はエラーとする。
* ロック取得に失敗した場合のレスポンス例:

```json
{
  "status": "error",
  "message": "lock_timeout"
}
```

* 読み取り専用処理（`mode=list`）については、MVPではロック対象外とし、書き込み処理と並列しても致命的でない前提とする。

---

### 7.3 ログイン API

* メソッド: `POST`
* パラメータ:

  * `mode=login`
  * `password=<入力された共有パスワード>`
* 処理:

  * GAS 内部に保持したハッシュ化済みパスワードと照合
* レスポンス:

  * 成功: `{ "status": "ok" }`
  * 失敗: `{ "status": "error", "message": "invalid_password" }`

---

### 7.4 支出登録 API

* メソッド: `POST`
* パラメータ:

  * `mode=add`
  * `date` : `YYYY-MM-DD`
  * `category` : 文字列
  * `amount` : 数値文字列
  * `payment_method` : 文字列（任意）
  * `note` : 文字列（任意）
* 処理:

  * `LockService.getScriptLock()` によりロックを取得してから処理を開始。
  * バリデーション（必須チェック・数値チェックなど）。
  * `id` 生成。
  * シートの末尾に行追加。
  * `created_at` / `updated_at` に現在時刻を設定。
* レスポンス（成功）例:

```json
{
  "status": "ok",
  "data": {
    "id": "generated-uuid"
  }
}
```

---

### 7.5 支出一覧取得 API

* メソッド: `GET`
* パラメータ:

  * `mode=list`
  * `year` : `YYYY`
  * `month` : `MM`（01〜12）
* 処理:

  * シート全体を読み込み（パフォーマンスが問題になる場合は範囲指定などを検討）。
  * 指定年月に一致する行をフィルタ。
  * 集計処理（合計・カテゴリ別合計）を実施。
* レスポンス（成功）例:

```json
{
  "status": "ok",
  "data": {
    "items": [
      {
        "id": "uuid-1",
        "date": "2025-01-01",
        "category": "食費",
        "amount": 1200,
        "payment_method": "クレジット",
        "note": "スーパー"
      }
    ],
    "summary": {
      "total": 1200,
      "byCategory": {
        "食費": 1200
      }
    }
  }
}
```

---

### 7.6 支出更新 API

* メソッド: `POST`
* パラメータ:

  * `mode=update`
  * `id` : 行ID
  * `date` / `category` / `amount` / `payment_method` / `note`（全て上書き値）
* 処理:

  * `LockService.getScriptLock()` によりロックを取得してから処理を開始。
  * `id` に一致する行を検索。
  * 該当行が存在する場合、各カラムを更新。
  * `updated_at` を現在時刻で更新。
* レスポンス:

  * 成功: `{ "status": "ok" }`
  * 失敗: `{ "status": "error", "message": "not_found" }`

---

### 7.7 支出削除 API

* メソッド: `POST`
* パラメータ:

  * `mode=delete`
  * `id` : 行ID
* 処理:

  * `LockService.getScriptLock()` によりロックを取得してから処理を開始。
  * `id` に一致する行を検索。
  * 該当行を削除。
* レスポンス:

  * 成功: `{ "status": "ok" }`
  * 失敗: `{ "status": "error", "message": "not_found" }`

---

## 8. 非機能要件（MVP）

### 8.1 性能

* 想定ユーザー数: 数名（家族）。
* 同時アクセス: 実質 1〜2 ユーザー。
* スプレッドシート行数: 数千行程度を想定。
  → GAS の実行時間制限を大きく超えない範囲で運用する。
* LockService により書き込み処理は直列化されるため、短時間に大量の書き込みリクエストが集中する運用は想定しない。

### 8.2 信頼性・可用性

* Google スプレッドシート / GAS / GitHub Pages の可用性に依存。
* データはスプレッドシートに即時保存されるため、フロント側での永続化は行わない。

### 8.3 セキュリティ

* 全通信は HTTPS。
* GAS Web アプリは、MVPでは匿名アクセスを許可する設定とし、アプリ内部の共有パスワードによる簡易認証で保護する。
* URL が第三者に知られた場合でも、共有パスワード不一致で家計簿データへの不正操作をある程度防ぐ。
* 家族内利用を前提とした「ライトな防御」であり、外部公開サービス程度の厳密なセキュリティは範囲外とする。

---

## 9. 運用・管理

* スプレッドシートのバックアップ

  * 定期的にコピーを作成してバックアップとして保管。
* GASコードの管理

  * GitHubリポジトリでフロントコードと合わせて管理（clasp導入は任意）。
* パスワードの変更

  * GAS内に保持するパスワードハッシュを更新し、家族に新パスワードを共有。
